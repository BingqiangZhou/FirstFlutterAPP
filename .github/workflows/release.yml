# GitHub Actions å·¥ä½œæµï¼šFlutter å¤šå¹³å°è‡ªåŠ¨æ„å»º
name: Build and Release App

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    tags:
      - "v*"  # åŒ¹é…æ‰€æœ‰ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0ã€v2.1.3 ç­‰
  workflow_dispatch:  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘

# æƒé™è®¾ç½®ï¼šå¿…é¡»æˆäºˆ contents: write æƒé™æ‰èƒ½åˆ›å»º Release
permissions:
  contents: write

jobs:
  # ========================
  # Android å¹³å°æ„å»ºä»»åŠ¡
  # ========================
  build-android:
    # ä½¿ç”¨ Ubuntu è™šæ‹Ÿç¯å¢ƒ
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç ï¼šè·å–ä»“åº“çš„æºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. è®¾ç½® Java ç¯å¢ƒï¼šAndroid æ„å»ºéœ€è¦ Java 17
      - name: Setup Java environment
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'  # ä½¿ç”¨ Eclipse Temurin JDK
          java-version: '17'       # Java ç‰ˆæœ¬

      # 3. è®¾ç½® Flutter ç¯å¢ƒï¼šå®‰è£… Flutter SDK
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬çš„ Flutter

      # 4. è·å–é¡¹ç›®ä¾èµ–ï¼šè¿è¡Œ flutter pub get ä¸‹è½½ä¾èµ–åŒ…
      - name: Get Flutter dependencies
        run: flutter pub get

      # 5. [å¯é€‰] è§£ç  Android ç­¾åå¯†é’¥ï¼ˆç”¨äºå‘å¸ƒç­¾åç‰ˆæœ¬ï¼‰
      # å¦‚æœéœ€è¦å‘å¸ƒç­¾åçš„ APKï¼Œéœ€è¦å…ˆé…ç½® GitHub Secrets
      - name: Decode Android keystore (if configured)
        run: |
          if [ "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" != "" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
            echo "storePassword=${{ secrets.KEY_PASSWORD }}" > android/key.properties
            echo "keyPassword=${{ secrets.ALIAS_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
            echo "storeFile=upload-keystore.jks" >> android/key.properties
          fi

      # 6. æ„å»º Android APKï¼šç”Ÿæˆå‘å¸ƒç‰ˆæœ¬çš„ Android å®‰è£…åŒ…
      - name: Build Android APK
        run: flutter build apk --release

      # 7. ä¸Šä¼  APK åˆ° GitHub Releaseï¼šå°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ° Releases é¡µé¢
      - name: Upload APK to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true  # å…è®¸æ›´æ–°å·²å­˜åœ¨çš„ Release
          artifacts: "build/app/outputs/flutter-apk/app-release.apk"  # APK æ–‡ä»¶è·¯å¾„
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub æä¾›çš„ token
          tag: ${{ github.ref_name }}  # ä½¿ç”¨æ¨é€çš„æ ‡ç­¾å
          name: Release ${{ github.ref_name }}  # Release æ ‡é¢˜
          body: |
            ## Flutter 2048 Game ${{ github.ref_name }}

            ğŸ® ä¸€ä¸ªä½¿ç”¨ Flutter å¼€å‘çš„ç»å…¸ 2048 æ•°å­—æ¸¸æˆ

            ### ğŸ“± æ”¯æŒå¹³å°
            - âœ… Android (APK)
            - âœ… Windows (Windows x64)
            - âœ… Linux (Linux x64)
            - âœ… macOS (macOS Universal)
            - âœ… Web (æµè§ˆå™¨)

            ### ğŸ“¥ å®‰è£…è¯´æ˜

            **Android:**
            - ä¸‹è½½ `app-release.apk` æ–‡ä»¶
            - åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…å¹¶è¿è¡Œ

            **Windows:**
            - ä¸‹è½½ `flutter-2048-windows.zip`
            - è§£å‹ç¼©å¹¶è¿è¡Œ `flutter_2048_game.exe`

            **Linux:**
            - ä¸‹è½½ `flutter-2048-linux.zip`
            - è§£å‹ç¼©å¹¶è¿è¡Œ `flutter_2048_game`

            **macOS:**
            - ä¸‹è½½ `flutter-2048-macos.zip`
            - è§£å‹ç¼©å¹¶è¿è¡Œ `Flutter 2048 Game.app`

            **Web:**
            - è®¿é—® [åœ¨çº¿æ¼”ç¤º](#) (æš‚æœªéƒ¨ç½² Web ç‰ˆæœ¬)

            ### ğŸ¯ æ¸¸æˆç‰¹è‰²
            - âŒ¨ï¸ æ”¯æŒé”®ç›˜æ–¹å‘é”®æ§åˆ¶
            - ğŸ“± æ”¯æŒè§¦æ‘¸æ»‘åŠ¨æ‰‹åŠ¿
            - ğŸ† åˆ†æ•°ç»Ÿè®¡å’Œæœ€é«˜åˆ†è®°å½•
            - ğŸ¨ å“åº”å¼è®¾è®¡ï¼Œé€‚é…å„ç§å±å¹•

            ### ğŸ”§ æŠ€æœ¯æ ˆ
            - Flutter ${{ env.FLUTTER_VERSION || '3.x' }}
            - Dart
            - Platform Channel Support

            ---
            ğŸ“… æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            ğŸŒŸ ç‰ˆæœ¬: ${{ github.ref_name }}
            ğŸ“¦ æ„å»ºäº§ç‰©: Android APK

  # ========================
  # Windows å¹³å°æ„å»ºä»»åŠ¡
  # ========================
  build-windows:
    # å¿…é¡»ä½¿ç”¨ Windows è™šæ‹Ÿç¯å¢ƒ
    runs-on: windows-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 3. è·å–ä¾èµ–
      - name: Get Flutter dependencies
        run: flutter pub get

      # 4. æ„å»º Windows åº”ç”¨ï¼šç”Ÿæˆ Windows æ¡Œé¢åº”ç”¨
      - name: Build Windows application
        run: flutter build windows --release

      # 5. æ‰“åŒ… Windows åº”ç”¨ï¼šå°†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ…æˆ ZIP
      - name: Archive Windows release
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'flutter-2048-windows.zip'  # ZIP æ–‡ä»¶å
          directory: 'build/windows/x64/runner/Release'  # Windows æ„å»ºè¾“å‡ºç›®å½•

      # 6. ä¸Šä¼  ZIP åˆ° GitHub Release
      - name: Upload Windows ZIP to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "build/windows/x64/runner/Release/flutter-2048-windows.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}

  # ========================
  # Linux å¹³å°æ„å»ºä»»åŠ¡
  # ========================
  build-linux:
    # ä½¿ç”¨ Ubuntu è™šæ‹Ÿç¯å¢ƒ
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£… Linux æ„å»ºä¾èµ–ï¼šFlutter Linux æ¡Œé¢åº”ç”¨éœ€è¦çš„ç³»ç»Ÿåº“
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            libglib2.0-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libcairo-gobject2 \
            libgdk-pixbuf2.0-dev \
            libgraphene-1.0-dev \
            libharfbuzz-dev

      # 3. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 4. è·å–ä¾èµ–
      - name: Get Flutter dependencies
        run: flutter pub get

      # 5. å¯ç”¨ Linux æ¡Œé¢æ”¯æŒ
      - name: Enable Linux desktop support
        run: flutter config --enable-linux-desktop

      # 6. æ„å»º Linux åº”ç”¨
      - name: Build Linux application
        run: flutter build linux --release

      # 7. æ‰“åŒ… Linux åº”ç”¨
      - name: Archive Linux release
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'flutter-2048-linux.zip'
          directory: 'build/linux/x64/release/bundle'  # Linux æ„å»ºè¾“å‡ºç›®å½•

      # 8. ä¸Šä¼  ZIP åˆ° GitHub Release
      - name: Upload Linux ZIP to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "build/linux/x64/release/bundle/flutter-2048-linux.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}

  # ========================
  # macOS å¹³å°æ„å»ºä»»åŠ¡
  # ========================
  build-macos:
    # å¿…é¡»ä½¿ç”¨ macOS è™šæ‹Ÿç¯å¢ƒ
    runs-on: macos-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 3. è·å–ä¾èµ–
      - name: Get Flutter dependencies
        run: flutter pub get

      # 4. å¯ç”¨ macOS æ¡Œé¢æ”¯æŒ
      - name: Enable macOS desktop support
        run: flutter config --enable-macos-desktop

      # 5. æ„å»º macOS åº”ç”¨
      - name: Build macOS application
        run: flutter build macos --release

      # 6. æ‰“åŒ… macOS åº”ç”¨ï¼š.app åŒ…æœ¬è´¨æ˜¯æ–‡ä»¶å¤¹ï¼Œéœ€è¦æ‰“åŒ…æˆ ZIP
      - name: Archive macOS release
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'flutter-2048-macos.zip'
          directory: 'build/macos/Build/Products/Release'  # macOS æ„å»ºè¾“å‡ºç›®å½•

      # 7. ä¸Šä¼  ZIP åˆ° GitHub Release
      - name: Upload macOS ZIP to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "build/macos/Build/Products/Release/flutter-2048-macos.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
