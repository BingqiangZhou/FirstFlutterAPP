# GitHub Actions 工作流：Flutter 多平台自动构建
name: Build and Release App

# 触发条件：当推送版本标签时或手动触发
on:
  push:
    tags:
      - "v*"  # 匹配所有以 v 开头的标签，如 v1.0.0、v2.1.3 等
  workflow_dispatch:  # 允许在 GitHub Actions 页面手动触发

# 权限设置：必须授予 contents: write 权限才能创建 Release
permissions:
  contents: write

jobs:
  # ========================
  # Android 平台构建任务
  # ========================
  build-android:
    # 使用 Ubuntu 虚拟环境
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码：获取仓库的源代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 设置 Java 环境：Android 构建需要 Java 17
      - name: Setup Java environment
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'  # 使用 Eclipse Temurin JDK
          java-version: '17'       # Java 版本

      # 3. 设置 Flutter 环境：安装 Flutter SDK
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # 使用稳定版本的 Flutter

      # 4. 获取项目依赖：运行 flutter pub get 下载依赖包
      - name: Get Flutter dependencies
        run: flutter pub get

      # 5. [可选] 解码 Android 签名密钥（用于发布签名版本）
      # 如果需要发布签名的 APK，需要先配置 GitHub Secrets
      - name: Decode Android keystore (if configured)
        run: |
          if [ "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" != "" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
            echo "storePassword=${{ secrets.KEY_PASSWORD }}" > android/key.properties
            echo "keyPassword=${{ secrets.ALIAS_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
            echo "storeFile=upload-keystore.jks" >> android/key.properties
          fi

      # 6. 构建 Android APK：生成发布版本的 Android 安装包
      - name: Build Android APK
        run: flutter build apk --release

      # 7. 上传 APK 到 GitHub Release：将构建产物上传到 Releases 页面
      - name: Upload APK to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true  # 允许更新已存在的 Release
          artifacts: "build/app/outputs/flutter-apk/app-release.apk"  # APK 文件路径
          token: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 提供的 token
          tag: ${{ github.ref_name }}  # 使用推送的标签名
          name: Release ${{ github.ref_name }}  # Release 标题
          body: "Auto-generated release for Android platform.\n\nVersion: ${{ github.ref_name }}"  # Release 描述

  # ========================
  # Windows 平台构建任务
  # ========================
  build-windows:
    # 必须使用 Windows 虚拟环境
    runs-on: windows-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 设置 Flutter 环境
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 3. 获取依赖
      - name: Get Flutter dependencies
        run: flutter pub get

      # 4. 构建 Windows 应用：生成 Windows 桌面应用
      - name: Build Windows application
        run: flutter build windows --release

      # 5. 打包 Windows 应用：将生成的可执行文件打包成 ZIP
      - name: Archive Windows release
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'flutter-2048-windows.zip'  # ZIP 文件名
          directory: 'build/windows/x64/runner/Release'  # Windows 构建输出目录

      # 6. 上传 ZIP 到 GitHub Release
      - name: Upload Windows ZIP to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "build/windows/x64/runner/Release/flutter-2048-windows.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}

  # ========================
  # Linux 平台构建任务
  # ========================
  build-linux:
    # 使用 Ubuntu 虚拟环境
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装 Linux 构建依赖：Flutter Linux 桌面应用需要的系统库
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            libglib2.0-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libcairo-gobject2 \
            libgdk-pixbuf2.0-dev \
            libgraphene-1.0-dev \
            libharfbuzz-dev

      # 3. 设置 Flutter 环境
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 4. 获取依赖
      - name: Get Flutter dependencies
        run: flutter pub get

      # 5. 启用 Linux 桌面支持
      - name: Enable Linux desktop support
        run: flutter config --enable-linux-desktop

      # 6. 构建 Linux 应用
      - name: Build Linux application
        run: flutter build linux --release

      # 7. 打包 Linux 应用
      - name: Archive Linux release
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'flutter-2048-linux.zip'
          directory: 'build/linux/x64/release/bundle'  # Linux 构建输出目录

      # 8. 上传 ZIP 到 GitHub Release
      - name: Upload Linux ZIP to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "build/linux/x64/release/bundle/flutter-2048-linux.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}

  # ========================
  # macOS 平台构建任务
  # ========================
  build-macos:
    # 必须使用 macOS 虚拟环境
    runs-on: macos-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 设置 Flutter 环境
      - name: Setup Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 3. 获取依赖
      - name: Get Flutter dependencies
        run: flutter pub get

      # 4. 启用 macOS 桌面支持
      - name: Enable macOS desktop support
        run: flutter config --enable-macos-desktop

      # 5. 构建 macOS 应用
      - name: Build macOS application
        run: flutter build macos --release

      # 6. 打包 macOS 应用：.app 包本质是文件夹，需要打包成 ZIP
      - name: Archive macOS release
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'flutter-2048-macos.zip'
          directory: 'build/macos/Build/Products/Release'  # macOS 构建输出目录

      # 7. 上传 ZIP 到 GitHub Release
      - name: Upload macOS ZIP to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "build/macos/Build/Products/Release/flutter-2048-macos.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
