# Flutter 2048 游戏测试指南

本指南介绍如何运行和编写 2048 游戏的测试。

## 目录

1. [运行测试](#运行测试)
2. [测试文件结构](#测试文件结构)
3. [测试用例说明](#测试用例说明)
4. [编写新测试](#编写新测试)
5. [常见测试技巧](#常见测试技巧)

## 运行测试

### 运行所有测试

在项目根目录运行：

```bash
flutter test
```

### 运行单个测试文件

```bash
flutter test test/widget_test.dart
```

### 运行特定测试组

```bash
flutter test --name "2048 Game UI Tests"
```

### 运行特定测试用例

```bash
flutter test --name "App displays correctly on startup"
```

### 查看详细测试输出

```bash
flutter test --verbose
```

### 生成测试覆盖率报告

```bash
flutter test --coverage
genhtml coverage/lcov.info -o coverage/html
```

## 测试文件结构

```
test/
└── widget_test.dart       # UI 组件测试
```

### 当前测试文件

- **`widget_test.dart`** - 包含所有 UI 组件的测试用例

## 测试用例说明

### 1. App displays correctly on startup

**测试目标**：验证应用启动时所有 UI 元素正确显示

**测试内容**：
- 应用标题 "2048 Game"
- 游戏标题 "2048"
- "新游戏" 按钮
- 分数和最高分显示框
- 操作提示文字

```dart
testWidgets('App displays correctly on startup', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());
  expect(find.text('2048 Game'), findsOneWidget);
  expect(find.text('2048'), findsOneWidget);
  // ... 更多验证
});
```

### 2. New game button resets the game

**测试目标**：验证"新游戏"按钮功能正常

**测试内容**：
- 按钮存在且可点击
- 点击后游戏网格正常显示

```dart
testWidgets('New game button resets the game', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());
  await tester.tap(find.text('新游戏'));
  await tester.pump();
  expect(find.byType(GridView), findsOneWidget);
});
```

### 3. Game responds to keyboard input

**测试目标**：验证游戏能响应键盘输入

**测试内容**：
- 模拟方向键按下
- 验证应用仍正常运行

```dart
testWidgets('Game responds to keyboard input', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());
  await tester.sendKeyDownEvent(LogicalKeyboardKey.arrowUp);
  await tester.sendKeyUpEvent(LogicalKeyboardKey.arrowUp);
  await tester.pump();
});
```

### 4. Game displays empty tiles initially

**测试目标**：验证游戏初始化时正确显示空的方块

**测试内容**：
- 验证 GridView 存在
- 检查方块容器数量

```dart
testWidgets('Game displays empty tiles initially', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());
  expect(find.byType(GridView), findsOneWidget);
  expect(find.byType(Container), findsWidgets);
});
```

## 编写新测试

### 基本测试结构

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_2048_game/main.dart';

void main() {
  group('测试分组名称', () {
    testWidgets('测试用例名称', (WidgetTester tester) async {
      // 1. 构建应用
      await tester.pumpWidget(const MyApp());

      // 2. 执行操作（可选）
      // await tester.tap(find.byType(SomeWidget));
      // await tester.pump();

      // 3. 验证结果
      expect(find.text('期望的文本'), findsOneWidget);
    });
  });
}
```

### 常用测试方法

#### 查找 Widget

```dart
// 通过文本查找
find.text('按钮文字')

// 通过 Widget 类型查找
find.byType(ElevatedButton)

// 通过 Key 查找（如果 Widget 有 Key）
find.byKey(Key('unique_key'))

// 查找第 N 个匹配的 Widget
find.text('文本').first
find.text('文本').at(1)
```

#### 执行交互

```dart
// 点击按钮
await tester.tap(find.byType(ElevatedButton));

// 输入文本
await tester.enterText(find.byType(TextField), '输入内容');

// 滑动
await tester.fling(find.byType(ListView), const Offset(0, -300), 1000);

// 拖拽
await tester.drag(find.byType(Draggable), const Offset(100, 0));

// 键盘事件
await tester.sendKeyDownEvent(LogicalKeyboardKey.arrowUp);
await tester.sendKeyUpEvent(LogicalKeyboardKey.arrowUp);

// 长按
await tester.longPress(find.byType(SomeWidget));
```

#### 验证结果

```dart
// 验证 Widget 存在
expect(find.byType(SomeWidget), findsOneWidget);
expect(find.text('文本'), findsWidgets);

// 验证 Widget 不存在
expect(find.text('不存在的文本'), findsNothing);

// 验证 Widget 数量
expect(find.byType(Container), findsNWidgets(16));

// 验证属性
final widget = tester.widget<Text>(find.text('文本'));
expect(widget.style?.fontSize, equals(16.0));

// 验证可见性
expect(tester.getSize(find.byType(SomeWidget)).width, greaterThan(0));
```

## 常见测试技巧

### 1. 等待异步操作

```dart
// 等待一帧
await tester.pump();

// 等待特定时间
await tester.pump(const Duration(seconds: 1));

// 等待所有动画完成
await tester.pumpAndSettle();
```

### 2. 处理平台差异

```dart
import 'dart:io' show Platform;

testWidgets('平台相关测试', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());

  if (Platform.isIOS) {
    // iOS 特定验证
  } else if (Platform.isAndroid) {
    // Android 特定验证
  }
});
```

### 3. 使用 Golden 测试（UI 快照）

```dart
testWidgets('UI 快照测试', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());

  // 与 golden 文件对比
  await expectLater(
    find.byType(MaterialApp),
    matchesGoldenFile('goldens/app.png'),
  );
});
```

### 4. 模拟网络请求

```dart
testWidgets('网络相关测试', (WidgetTester tester) async {
  // 使用 mock 包如 mockito 或 http_mock_adapter
  // 设置 mock 响应

  await tester.pumpWidget(const MyApp());

  // 验证网络请求后的 UI 变化
});
```

### 5. 测试动画

```dart
testWidgets('动画测试', (WidgetTester tester) async {
  await tester.pumpWidget(const MyApp());

  // 开始动画
  await tester.tap(find.byType(AnimatedButton));
  await tester.pump();

  // 验证动画开始时的状态
  expect(find.text('动画中'), findsOneWidget);

  // 继续动画到下一帧
  await tester.pump(const Duration(milliseconds: 500));

  // 验证动画中间状态
  expect(find.text('动画中'), findsOneWidget);

  // 等待动画完成
  await tester.pumpAndSettle();

  // 验证动画完成后的状态
  expect(find.text('完成'), findsOneWidget);
});
```

## 调试测试

### 打印 Widget 树

```dart
import 'package:flutter/rendering.dart';

// 在测试中打印 Widget 树
debugDumpApp();
```

### 使用 debugger

```bash
flutter test --debug
```

### 查看测试失败详情

```bash
flutter test --reporter=expanded
```

## 持续集成

在 GitHub Actions 中运行测试：

```yaml
- name: Run Flutter tests
  run: flutter test
```

生成覆盖率报告：

```yaml
- name: Generate coverage report
  run: |
    flutter test --coverage
    genhtml coverage/lcov.info -o coverage/html
```

## 最佳实践

1. **保持测试简单** - 每个测试应该只验证一个功能
2. **使用描述性的测试名称** - 测试名称应该清楚地说明测试内容
3. **避免测试实现细节** - 测试用户可见的行为，而不是内部实现
4. **合理使用分组** - 使用 `group` 组织相关测试
5. **保持测试独立** - 测试之间不应相互依赖
6. **定期运行测试** - 在提交代码前运行所有测试

## 参考资料

- [Flutter Testing 文档](https://flutter.dev/docs/cookbook/testing)
- [WidgetTester API 文档](https://api.flutter.dev/flutter/flutter_test/WidgetTester-class.html)
- [Finder 类文档](https://api.flutter.dev/flutter/flutter_test/Finder-class.html)